# 编解码器选择逻辑

## 核心原则

1. **用户选择优先**：`userXXX` > `selectedXXX`
2. **格式必须匹配**：编码器和解码器必须同格式（如 H.265 配 H.265）
3. **系统自动兜底**：用户未选的部分由系统自动选择

## 字段说明

```kotlin
// 用户手动选择（优先级最高，UI 修改）
userVideoEncoder / userVideoDecoder
userAudioEncoder / userAudioDecoder

// 系统自动选择（兜底，检测时更新）
selectedVideoEncoder / selectedVideoDecoder
selectedAudioEncoder / selectedAudioDecoder

// 最终使用（用户选择 > 系统选择）
getFinalVideoEncoder() = userVideoEncoder.ifBlank { selectedVideoEncoder }
```

## 检测触发条件（以视频为例）

### 情况 1：用户全选
- `userVideoEncoder` ✓ + `userVideoDecoder` ✓
- **结果**：不检测

### 情况 2：用户选了编码器
- `userVideoEncoder` ✓ + `userVideoDecoder` ✗
- **判断**：
  - `selectedVideoDecoder` 为空 → 检测
  - `selectedVideoDecoder` 有值 → 检查格式是否匹配
    - 匹配 → 不检测
    - 不匹配 → 检测（重新选择匹配的解码器）

### 情况 3：用户选了解码器
- `userVideoEncoder` ✗ + `userVideoDecoder` ✓
- **判断**：
  - `selectedVideoEncoder` 为空 → 检测
  - `selectedVideoEncoder` 有值 → 检查格式是否匹配
    - 匹配 → 不检测
    - 不匹配 → 检测（重新选择匹配的编码器）

### 情况 4：用户都没选
- `userVideoEncoder` ✗ + `userVideoDecoder` ✗
- **判断**：
  - `selectedVideoEncoder` 和 `selectedVideoDecoder` 都有值 → 不检测
  - 否则 → 检测

## 格式推断

### 视频格式
- `hevc` / `h265` → h265
- `avc` / `h264` → h264
- `av01` / `av1` → av1
- `vp9` → vp9
- `vp8` → vp8

### 音频格式
- `opus` → opus
- `aac` → aac
- `flac` → flac
- `raw` → raw

## 选择策略

```kotlin
selectBestVideoCodec(
    remoteEncoders: List<String>,
    userEncoder: String? = null,
    userDecoder: String? = null
)
```

1. **用户全选** → 直接返回
2. **用户只选编码器** → 找匹配格式的最佳解码器
3. **用户只选解码器** → 找匹配格式的最佳编码器
4. **用户都没选** → 自动选择最佳组合

### 自动选择优先级

**视频解码器**：硬件+low_latency+C2 > 硬件+low_latency > 硬件+C2 > 硬件 > 软件  
**视频格式**：H.265 > H.264 > AV1 > VP9 > VP8  
**音频格式**：OPUS > AAC > FLAC > RAW

## 示例

### 用户选了 H.265 编码器，系统之前选了 H.264 解码器
1. 推断格式：用户 h265 vs 系统 h264
2. 格式不匹配 → 触发检测
3. 系统重新选择 H.265 解码器
4. 最终：用户 H.265 编码器 + 系统 H.265 解码器
