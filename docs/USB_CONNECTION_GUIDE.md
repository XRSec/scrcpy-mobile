# USB 有线连接使用指南

## 功能概述

Scrcpy Mobile 现已支持 USB 有线连接，可以通过 USB 数据线直接连接两台 Android 设备，无需 WiFi 网络。

## 前置要求

1. **硬件要求**
   - 控制端设备需支持 USB Host 功能（大部分 Android 设备支持）
   - USB OTG 数据线或 USB-C to USB-C 数据线
   - 被控端设备需开启 USB 调试

2. **软件要求**
   - Android 6.0+ (API 23+)
   - 被控端设备已开启 USB 调试
   - 被控端设备已授权控制端设备的 ADB 密钥

## 使用步骤

### 1. 连接设备

1. 使用 USB 数据线连接两台设备
2. 打开 Scrcpy Mobile 应用
3. 点击主界面的 "设备管理" 或 "添加设备"
4. 在弹出的对话框中点击 "USB 有线连接"

### 2. 授权 USB 权限

首次连接时，系统会弹出 USB 权限请求对话框：
- 点击 "确定" 授权
- 可勾选 "默认使用此应用打开" 避免每次都弹出

### 3. 选择设备

1. 应用会自动扫描可用的 USB 设备
2. 在列表中选择要连接的设备
3. 查看设备信息：
   - 制造商和产品名
   - 序列号
   - 权限状态（已授权/未授权）
4. 点击 "连接" 按钮

### 4. 开始镜像

连接成功后，设备会出现在已连接设备列表中，标记为 "USB" 连接类型。
点击设备即可开始屏幕镜像。

## 常见问题

### Q1: 扫描不到 USB 设备？

**可能原因**：
- USB 数据线未正确连接
- 控制端设备不支持 USB Host
- 被控端设备未开启 USB 调试

**解决方法**：
1. 检查 USB 连接是否牢固
2. 尝试更换 USB 数据线
3. 确认被控端设备已开启 USB 调试
4. 在被控端设备的开发者选项中选择 "USB 配置" → "MTP" 或 "PTP"

### Q2: USB 权限被拒绝？

**解决方法**：
1. 重新插拔 USB 数据线
2. 在系统设置中清除应用数据后重试
3. 手动授权：设置 → 应用 → Scrcpy Mobile → 权限 → USB

### Q3: 连接失败？

**可能原因**：
- ADB Server 未运行
- 被控端设备未授权 ADB 密钥
- USB 连接不稳定

**解决方法**：
1. 确保被控端设备已授权 ADB 密钥（首次连接会弹出授权对话框）
2. 尝试先通过 TCP/IP 连接一次，完成 ADB 密钥授权
3. 检查 USB 数据线质量

### Q4: 连接后无法控制？

**解决方法**：
1. 确认被控端设备已授权 ADB 密钥
2. 检查被控端设备的 USB 调试是否仍然开启
3. 尝试断开重连

## USB vs TCP/IP 对比

| 特性 | USB 连接 | TCP/IP 连接 |
|------|---------|------------|
| 连接稳定性 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ |
| 传输速度 | 快 | 取决于网络 |
| 延迟 | 低 | 取决于网络 |
| 便携性 | 需要数据线 | 无需数据线 |
| 功耗 | 可同时充电 | 较高 |
| 适用场景 | 长时间使用、高质量需求 | 临时使用、无数据线 |

## 技术说明

### 实现原理

1. **设备发现**：通过 Android USB Host API 扫描 USB 设备
2. **设备识别**：检查 USB 接口类型（class=0xFF, subclass=0x42, protocol=0x01）
3. **权限管理**：请求 USB_PERMISSION 权限
4. **ADB 连接**：使用 dadb 库的 AdbServer 功能建立连接
5. **数据传输**：通过 ADB 协议进行数据传输

### 依赖库

- **dadb**: 纯 Kotlin 实现的 ADB 库
- **Android USB Host API**: 系统提供的 USB 设备访问接口

### 参考项目

- **Easycontrol**: USB 设备发现逻辑
- **dadb**: ADB Server 集成

## 故障排查

### 启用调试日志

1. 进入应用设置
2. 开启 "启用日志记录"
3. 重现问题
4. 导出日志文件

### 日志关键字

- `UsbAdbManager`: USB 设备管理相关
- `AdbConnectionManager`: 连接管理相关
- `USB_SCANNING_DEVICES`: 设备扫描
- `USB_PERMISSION`: 权限请求
- `USB_CONNECTING_DEVICE`: 设备连接

## 注意事项

1. **首次连接**：需要在被控端设备上授权 ADB 密钥
2. **权限管理**：USB 权限需要每次插拔后重新授权（除非勾选默认使用）
3. **设备兼容性**：部分设备可能不支持 USB Host 功能
4. **数据线质量**：建议使用原装或高质量数据线
5. **电源管理**：USB 连接可能会影响设备充电速度

## 更新日志

### v4.4.0 (2026-01-25)
- ✨ 新增 USB 有线连接功能
- ✨ 支持 USB 设备自动扫描
- ✨ 支持 USB 权限管理
- ✨ 统一 TCP 和 USB 连接管理
- 🌐 添加完整的双语支持

## 反馈与支持

如遇到问题，请：
1. 查看本指南的常见问题部分
2. 导出日志文件
3. 在 GitHub 提交 Issue，附上日志文件和设备信息
