
## Scrcpy 音频编码器数据包格式完整分析

### 测试环境
- **采样率**: 48000 Hz
- **声道数**: 2 (立体声)
- **测试场景**: 静音状态
- **协议**: Scrcpy 音频流协议（12字节头 + 数据）

---

### 1. Opus 编码器 (c2.android.opus.encoder)

#### 配置包 (Packet #1)
```
大小: 19 字节
标志: CONFIG (PTS 最高位为 1)
完整数据: 4F 70 75 73 48 65 61 64 01 02 38 01 80 BB 00 00 00 00 00
```

###### 配置包结构解析
| 偏移 | 长度 | 字段 | 值 | 说明 |
|------|------|------|-----|------|
| 0-7 | 8 | Magic | `4F 70 75 73 48 65 61 64` | "OpusHead" ASCII |
| 8 | 1 | Version | `01` | Opus 版本 1 |
| 9 | 1 | Channel Count | `02` | 2 声道 |
| 10-11 | 2 | Pre-skip | `38 01` | 312 采样 (小端序) |
| 12-15 | 4 | Sample Rate | `80 BB 00 00` | 48000 Hz (小端序) |
| 16-17 | 2 | Output Gain | `00 00` | 0 dB |
| 18 | 1 | Channel Mapping | `00` | 单流立体声 |

#### 音频数据包 (Packet #2+)
```
大小: 3 字节 (固定)
标志: NORMAL
数据: FC FF FE (所有包相同)
PTS: 递增时间戳
  #2:  1178612108142
  #3:  1178612090539
  #4:  1178612111995
  #50: 1178613030896
  #100: 1178614033434
  #300: 1178618043180
```

###### 数据包特征
- **固定大小**: 3 字节
- **内容不变**: `FC FF FE` 表示 Opus 静音帧
- **无帧头**: 直接是 Opus 编码数据
- **无帧序号**: 依赖 PTS 排序

---

### 2. AAC 编码器 (默认)

#### 配置包 (Packet #1)
```
大小: 2 字节
标志: CONFIG
完整数据: 11 90
```

###### 配置包结构解析 (AudioSpecificConfig)
```
二进制: 0001 0001 1001 0000
```

| 字段 | 位 | 值 | 说明 |
|------|-----|-----|------|
| Audio Object Type | 5 bits | `00010` | 2 = AAC-LC |
| Sample Rate Index | 4 bits | `0011` | 3 = 48000 Hz |
| Channel Config | 4 bits | `0010` | 2 = 立体声 |
| Frame Length Flag | 1 bit | `0` | 1024 采样/帧 |
| Depends on Core Coder | 1 bit | `0` | 不依赖 |
| Extension Flag | 1 bit | `0` | 无扩展 |

#### 音频数据包 (Packet #2+)
```
大小: 128 字节 (固定)
标志: NORMAL
数据前缀: 21 11 45 00 14 50 01 46 F6 81 0A
数据主体: 5A 5A 5A 5A 5A... (重复到 128 字节)
PTS: 递增时间戳
  #2:  1179378234251
  #3:  1179378255584
  #4:  1179378276922
  #50: 1179379259636
  #100: 1179380326286
```

###### 数据包特征
- **固定大小**: 128 字节
- **帧头**: `21 11 45 00 14 50 01 46 F6 81 0A` (11 字节)
- **填充数据**: `5A` 重复填充 (静音填充模式)
- **无 ADTS 头**: 使用 Raw AAC 格式
- **固定帧长**: 不随内容变化

---

### 3. FLAC 编码器 (默认)

#### 配置包 (Packet #1)
```
大小: 34 字节
标志: CONFIG
完整数据: 10 00 10 00 00 00 00 00 00 00 0B B8 02 F0 00 00 00 00 00 00 
          00 00 00 00 00 00 00 00 00 00 00 00 00 00
```

###### 配置包结构解析 (STREAMINFO 块)
| 偏移 | 长度 | 字段 | 值 | 说明 |
|------|------|------|-----|------|
| 0-1 | 2 | Min Block Size | `10 00` | 4096 采样 (大端序) |
| 2-3 | 2 | Max Block Size | `10 00` | 4096 采样 (大端序) |
| 4-6 | 3 | Min Frame Size | `00 00 00` | 0 (未知) |
| 7-9 | 3 | Max Frame Size | `00 00 00` | 0 (未知) |
| 10-11 | 2 | Sample Rate (高位) | `0B B8` | 48000 Hz 的高 20 位 |
| 12 | 1 | Sample Rate (低位) + Channels | `02` | 低 4 位 + 2 声道 |
| 13 | 1 | Bits Per Sample + Total Samples | `F0` | 16 位 |
| 14-33 | 20 | MD5 + 填充 | `00...` | 全零 |

#### 音频数据包 (Packet #2+)
```
大小: 14 字节 (固定)
标志: NORMAL
数据格式: FF F8 CA 18 [帧序号] [CRC]
PTS: 递增时间戳
  #2:  1179469562355  数据: FF F8 CA 18 00 7F 00 00 00 00 00 00 AE 02
  #3:  1179469629590  数据: FF F8 CA 18 01 78 00 00 00 00 00 00 39 77
  #4:  1179469714447  数据: FF F8 CA 18 02 71 00 00 00 00 00 00 00 ED
  #5:  1179469800131  数据: FF F8 CA 18 03 76 00 00 00 00 00 00 97 98
  #10: 1179470226323  数据: FF F8 CA 18 08 47 00 00 00 00 00 00 95 B1
  #20: 1179470909323  数据: FF F8 CA 18 12 01 00 00 00 00 00 00 77 8B
```

###### 数据包结构解析
| 偏移 | 长度 | 字段 | 值 | 说明 |
|------|------|------|-----|------|
| 0-1 | 2 | Sync Code | `FF F8` | FLAC 帧同步码 |
| 2-3 | 2 | Frame Header | `CA 18` | 帧参数 |
| 4-5 | 2 | Frame Number | 递增 | `00 7F`, `01 78`, `02 71`... |
| 6-11 | 6 | Compressed Data | `00 00 00 00 00 00` | 静音压缩数据 |
| 12-13 | 2 | CRC-16 | 变化 | 帧校验码 |

###### 数据包特征
- **固定大小**: 14 字节 (静音时)
- **同步码**: `FF F8` 标识 FLAC 帧
- **帧序号**: 递增，用于检测丢包
- **CRC 校验**: 每帧不同，保证完整性
- **高压缩率**: 静音时仅 14 字节

---

### 4. RAW 编码器 (PCM)

#### 配置包
```
无配置包
第一个包直接是音频数据
```

#### 音频数据包 (Packet #1+)
```
大小: 4096 字节 (固定)
标志: NORMAL (第一个包也是 NORMAL，不是 CONFIG)
数据: 00 00 00 00 00 00 00 00... (全零，共 4096 字节)
PTS: 递增时间戳
  #1:  1179565440844
  #2:  1179565462177
  #3:  1179565462198
  #4:  1179565478243
  #5:  1179565501584
  #10: 1179565604938
  #20: 1179566009323
```

###### 数据包结构解析
```
格式: PCM 16-bit 立体声，小端序
大小: 4096 字节 = 2048 采样 = 1024 采样/声道
时长: 1024 / 48000 ≈ 21.33 毫秒/帧
```

| 字段 | 值 | 说明 |
|------|-----|------|
| 格式 | PCM | 未压缩线性 PCM |
| 位深 | 16-bit | 每采样 2 字节 |
| 字节序 | 小端序 | Little-endian |
| 交错 | 是 | L R L R L R... |
| 采样数 | 2048 | 1024 × 2 声道 |

###### 数据包特征
- **无压缩**: 原始 PCM 数据
- **固定大小**: 4096 字节
- **无帧头**: 纯数据流
- **静音表示**: `00 00` = 0 值采样
- **最大带宽**: 4096 字节/帧

---

### 完整对比表

#### 配置包对比
| 编码器 | 大小 | 标志 | 格式 | 关键标识 |
|--------|------|------|------|----------|
| **Opus** | 19 字节 | CONFIG | OpusHead | `4F 70 75 73 48 65 61 64` |
| **AAC** | 2 字节 | CONFIG | AudioSpecificConfig | `11 90` |
| **FLAC** | 34 字节 | CONFIG | STREAMINFO | `10 00 10 00` |
| **RAW** | 无 | - | - | - |

#### 数据包对比
| 编码器 | 大小 | 帧头 | 帧序号 | 校验 | 静音数据 |
|--------|------|------|--------|------|----------|
| **Opus** | 3 字节 | 无 | 无 | 无 | `FC FF FE` |
| **AAC** | 128 字节 | 11 字节 | 无 | 无 | `21 11 45...5A 5A...` |
| **FLAC** | 14 字节 | `FF F8` | 有 | CRC-16 | `FF F8 CA 18 [seq] 00... [crc]` |
| **RAW** | 4096 字节 | 无 | 无 | 无 | `00 00 00 00...` |

#### 性能对比 (静音场景)

###### 带宽占用 (每秒)
假设 48kHz 采样率，计算每秒数据量：

| 编码器 | 帧大小 | 帧时长 | 帧率 | 每秒数据量 | 相对比例 |
|--------|--------|--------|------|------------|----------|
| **Opus** | 3 字节 | ~20ms | 50 fps | 150 字节/秒 | 1× |
| **FLAC** | 14 字节 | ~21ms | 47 fps | 658 字节/秒 | 4.4× |
| **AAC** | 128 字节 | ~21ms | 47 fps | 6,016 字节/秒 | 40× |
| **RAW** | 4096 字节 | ~21ms | 47 fps | 192,512 字节/秒 | 1,283× |

###### 压缩率对比
```
原始 PCM: 192,512 字节/秒 (基准)

Opus: 150 / 192,512 = 0.078%  (压缩率 99.92%)
FLAC: 658 / 192,512 = 0.34%   (压缩率 99.66%)
AAC:  6,016 / 192,512 = 3.1%  (压缩率 96.9%)
RAW:  192,512 / 192,512 = 100% (无压缩)
```

#### 特性对比

| 特性 | Opus | AAC | FLAC | RAW |
|------|------|-----|------|-----|
| **压缩类型** | 有损 | 有损 | 无损 | 无 |
| **静音压缩** | 极优 | 差 | 优 | 无 |
| **延迟** | 低 (~20ms) | 低 (~21ms) | 低 (~21ms) | 最低 (~21ms) |
| **CPU 占用** | 中 | 中 | 高 | 无 |
| **带宽效率** | 最优 | 差 | 优 | 最差 |
| **音质** | 高 | 高 | 无损 | 无损 |
| **错误恢复** | 好 | 中 | 好 (CRC) | 无 |
| **帧同步** | 无 | 无 | 有 (`FF F8`) | 无 |
| **丢包检测** | 依赖 PTS | 依赖 PTS | 帧序号 + PTS | 依赖 PTS |

#### 适用场景

###### Opus - 最佳实时传输
- ✅ 网络带宽受限
- ✅ 移动网络环境
- ✅ 低延迟要求
- ✅ 静音场景多
- ❌ 需要无损音质

###### AAC - 通用兼容性
- ✅ 设备兼容性要求高
- ✅ 硬件解码支持
- ✅ 标准化需求
- ❌ 带宽受限
- ❌ 静音场景多

###### FLAC - 无损高质量
- ✅ 音质要求高
- ✅ 需要无损压缩
- ✅ 存储空间充足
- ✅ 需要错误检测
- ❌ 极低带宽环境

###### RAW - 最低延迟
- ✅ 本地回放
- ✅ 无需压缩
- ✅ CPU 资源受限
- ✅ 带宽充足
- ❌ 网络传输
- ❌ 存储空间受限

---

### 实现建议

#### 解码器选择逻辑
```kotlin
when (codec) {
    "opus" -> {
        // 检查配置包: "OpusHead" (19 字节)
        // 提取 CSD-0 用于 MediaCodec
        // 数据包: 3 字节静音帧
    }
    "aac" -> {
        // 检查配置包: AudioSpecificConfig (2 字节)
        // 提取 CSD-0 用于 MediaCodec
        // 数据包: 128 字节固定帧
    }
    "flac" -> {
        // 检查配置包: STREAMINFO (34 字节)
        // 提取 CSD-0 用于 MediaCodec
        // 数据包: 14 字节 + FLAC 帧头 (FF F8)
        // 可验证 CRC-16
    }
    "raw" -> {
        // 无配置包
        // 直接送入 AudioTrack
        // 数据包: 4096 字节 PCM
    }
}
```

#### 关键实现点

1. **配置包识别**: 检查 PTS 最高位 (CONFIG 标志)
2. **格式验证**: 根据魔数/大小验证格式
3. **CSD-0 提取**: Opus/AAC/FLAC 需要配置数据
4. **帧同步**: FLAC 可用 `FF F8` 同步
5. **错误处理**: FLAC 可验证 CRC，其他依赖 PTS

---

### 总结

四种编码器各有特点：

- **Opus**: 静音时最高效 (3 字节)，最适合实时传输
- **AAC**: 固定帧大小 (128 字节)，兼容性最好
- **FLAC**: 无损压缩 (14 字节)，带帧同步和校验
- **RAW**: 未压缩 (4096 字节)，延迟最低但带宽最大

在 Scrcpy 场景下，**Opus 是最佳选择**，因为：
1. 静音时带宽占用最小 (150 字节/秒)
2. 延迟低 (~20ms)
3. 音质好
4. 适合移动网络

